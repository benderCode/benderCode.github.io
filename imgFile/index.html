<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ImgFile-文件处理</title>
    <link rel="stylesheet" href="../css/reset.css">
    <script src="../js/JQuery.1.12.4.min.js"></script>
    <script src="../js/GetObjectURL.js"></script>
    <style>
        .container {
            height: 50vh;
            margin: 0 auto;
            background: #dddddd;
            overflow-y: scroll;
        }

        .fileBtnContent {
            position: relative;
            height: 35px;
            line-height: 35px;
            background: purple;
            border-radius: 8px;
        }

        .fileBtn {
            display: block;
            font-size: 12px;
            color: #ffffff;
            text-align: center;
        }

        .fileInput {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
        }

        .imgItem {
            display: inline-block;
            width: 80px;
            height: 120px;
            margin: 10px;
        }

        .imgItem>img {
            display: block;
            width: 100%;
            height: 100%;
        }
    </style>
    <script>
        $(function () {
            // 图片压缩 ES6 canvas
            function reduceImg(base64) {
                return new Promise(function (resolve, reject) {
                    var canvas = document.createElement('canvas');
                    var context = canvas.getContext('2d');
                    var img = new Image();
                    img.src = base64;
                    // base64地址图片加载完毕后
                    img.onload = function () {
                        // 图片原始尺寸
                        var originWidth = this.width;
                        var originHeight = this.height;
                        // 最大尺寸限制，可通过国设置宽高来实现图片压缩程度
                        var maxWidth = 800,
                            maxHeight = 800;
                        // 目标尺寸
                        var targetWidth = originWidth,
                            targetHeight = originHeight;
                        // 图片尺寸超过400x400的限制
                        if (originWidth > maxWidth || originHeight > maxHeight) {
                            if (originWidth / originHeight > maxWidth / maxHeight) {
                                // 更宽，按照宽度限定尺寸
                                targetWidth = maxWidth;
                                targetHeight = Math.round(maxWidth * (originHeight / originWidth));
                            } else {
                                targetHeight = maxHeight;
                                targetWidth = Math.round(maxHeight * (originWidth / originHeight));
                            }
                        }
                        // canvas对图片进行缩放
                        canvas.width = targetWidth;
                        canvas.height = targetHeight;
                        // 清除画布
                        context.clearRect(0, 0, targetWidth, targetHeight);
                        // 图片压缩
                        context.drawImage(img, 0, 0, targetWidth, targetHeight);
                        /*第一个参数是创建的img对象；第二个参数是左上角坐标，后面两个是画布区域宽高*/
                        //压缩后的图片base64 url
                        /*canvas.toDataURL(mimeType, qualityArgument),mimeType 默认值是'image/jpeg';
                         * qualityArgument表示导出的图片质量，只要导出为jpg和webp格式的时候此参数才有效果，默认值是0.92*/
                        //base64 格式
                        resolve(canvas.toDataURL('image/jpeg', 0.92));
                    }
                })
            }


            // 上传图片 - start
            $(".fileInput0").change(function () {
                var imgArr = [];// 存放数据数组
                var uploadFile = $(this)[0].files;// 选择的图片资源 

                var fileIndex = 0;// 循环的索引

                // file对象 uploadFile[fileIndex]
                // name:"logo.png" // 文件名
                // size:27268   // 大小KB
                // type:"image/png" // 类型

                // new FileReader() 对象 获取图片的 base64 
                var reader = new FileReader();

                reader.readAsDataURL(uploadFile[fileIndex]);

                // new FileReader() 对象读取完成方法 onload
                reader.onload = function (e) {

                    // e.target.result 读取到的 base64 
                    if (e.target.result) {

                        // 文件类型校验
                        if (/(.png|.jpg|.jpeg)$/gi.test(uploadFile[fileIndex].name)) {
                            // 符合校验操作
                            reduceImg(e.target.result).then(function (newUrl) {
                                $(".base64Img").append('<li class="imgItem">\
                                    <img src="'+ newUrl + '" alt="">\
                                </li>')
                            })
                        } else {
                            // 不符合校验操作
                            console.log("不符合")
                        }

                        // 增加索引
                        fileIndex++;
                        if (fileIndex < uploadFile.length) {
                            reader.readAsDataURL(uploadFile[fileIndex]);
                        }
                    }
                }
            })


            $(".fileInput1").change(function () {
                var files = $(this)[0].files;
                var _blobHtml = "";
                for (var i = 0; i < files.length; i++) {
                    _blobHtml += '<li class="imgItem">\
                        <img src="'+ getObjectURL(files[i]) + '" alt="">\
                    </li>'
                }
                $(".blobImg").html(_blobHtml);
            })
        })
    </script>
</head>

<body>
    <div class="container">
        <!-- 上传按钮 - start -->
        <div class="fileBtnContent">
            <a class="fileBtn" href="javascript:;">选择文件(base64渲染图片)</a>
            <input class="fileInput fileInput0" type="file" multiple="multiple">
        </div>
        <!-- 上传按钮 - end -->
        <!-- 盛放图片的容器 - start -->
        <ul class="imgUl base64Img">
            <!-- <li class="imgItem">
                <img src="" alt="">
            </li> -->
        </ul>
        <!-- 盛放图片的容器 - end -->
    </div>
    <div class="container">
        <!-- 上传按钮 - start -->
        <div class="fileBtnContent">
            <a class="fileBtn" href="javascript:;">选择文件(本地文件路径读取图片)</a>
            <input class="fileInput fileInput1" type="file" multiple="multiple">
        </div>
        <!-- 上传按钮 - end -->
        <!-- 盛放图片的容器 - start -->
        <ul class="imgUl blobImg">
            <!-- <li class="imgItem">
                    <img src="" alt="">
                </li> -->
        </ul>
        <!-- 盛放图片的容器 - end -->
    </div>
</body>

</html>